generator client {
  provider      = "prisma-client-js"
  output        = "../src/generated/prisma"
  binaryTargets = ["native", "debian-openssl-3.0.x", "debian-openssl-1.1.x", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Image {
  id                   String               @id @default(cuid())
  name                 String
  tag                  String
  registry             String?
  source               ImageSource          @default(REGISTRY)
  digest               String               @unique
  platform             String?
  sizeBytes            Int?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  bulkScanItems        BulkScanItem[]
  cveClassifications   CveClassification[]
  imageVulnerabilities ImageVulnerability[]
  scans                Scan[]
  
  // Patch relations
  patchOperationsAsSource   PatchOperation[]     @relation("PatchSourceImage")
  patchOperationsAsPatched  PatchOperation[]     @relation("PatchedImage")
  patchedImagesAsOriginal   PatchedImage[]       @relation("PatchedImageOriginal")
  patchedImagesAsResult     PatchedImage[]       @relation("PatchedImageResult")

  @@index([name, tag])
  @@index([registry, name, tag])
  @@index([digest])
  @@index([registry])
  @@index([source])
  @@map("images")
}

model Scan {
  id               String            @id @default(cuid())
  requestId        String            @unique
  imageId          String
  startedAt        DateTime
  finishedAt       DateTime?
  status           ScanStatus        @default(RUNNING)
  reportsDir       String?
  errorMessage     String?
  riskScore        Int?
  metadataId       String?           @unique
  source           String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  bulkScanItems              BulkScanItem[]
  scanResults                ScanResult[]
  metadata                   ScanMetadata?              @relation(fields: [metadataId], references: [id], onDelete: SetNull)
  image                      Image                      @relation(fields: [imageId], references: [id], onDelete: Cascade)
  vulnerabilityFindings      ScanVulnerabilityFinding[]
  packageFindings            ScanPackageFinding[]
  complianceFindings         ScanComplianceFinding[]
  efficiencyFindings         ScanEfficiencyFinding[]
  findingCorrelations        ScanFindingCorrelation[]
  patchOperations            PatchOperation[]

  @@index([requestId])
  @@index([status])
  @@index([startedAt])
  @@index([imageId])
  @@index([imageId, status])
  @@index([imageId, startedAt])
  @@index([status, startedAt])
  @@index([metadataId])
  @@map("scans")
}

model ScanMetadata {
  id                     String   @id @default(cuid())
  
  // Docker Image metadata
  dockerId               String?
  dockerOs               String?
  dockerArchitecture     String?
  dockerSize             BigInt?
  dockerAuthor           String?
  dockerCreated          DateTime?
  dockerVersion          String?
  dockerParent           String?
  dockerComment          String?
  dockerDigest           String?
  dockerConfig           Json?    // Complex nested object
  dockerRootFS           Json?    // Layers array
  dockerGraphDriver      Json?
  dockerRepoTags         Json?    // Array of strings
  dockerRepoDigests      Json?    // Array of strings
  dockerMetadata         Json?    // Docker-specific metadata
  dockerLabels           Json?    // Label key-value pairs
  dockerEnv              Json?    // Environment variables array
  
  // Scan Results from each scanner (kept for downloads)
  trivyResults           Json?
  grypeResults           Json?
  syftResults            Json?
  dockleResults          Json?
  osvResults             Json?
  diveResults            Json?
  
  // Aggregated Data
  vulnerabilityCritical  Int      @default(0)
  vulnerabilityHigh      Int      @default(0)
  vulnerabilityMedium    Int      @default(0)
  vulnerabilityLow       Int      @default(0)
  vulnerabilityInfo      Int      @default(0)
  complianceScore        Int?
  complianceGrade        String?
  complianceFatal        Int?
  complianceWarn         Int?
  complianceInfo         Int?
  compliancePass         Int?
  aggregatedRiskScore    Int?
  
  // Scanner versions
  scannerVersions        Json?
  
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  
  scan                   Scan?
  
  // Relations to new scan result tables
  grypeResult            GrypeResults?
  trivyResult            TrivyResults?
  diveResult             DiveResults?
  syftResult             SyftResults?
  dockleResult           DockleResults?
  osvResult              OsvResults?
  
  @@index([dockerDigest])
  @@index([aggregatedRiskScore])
  @@map("scan_metadata")
}

// ============================================
// Individual Scanner Result Tables
// ============================================

model GrypeResults {
  id                String        @id @default(cuid())
  scanMetadataId    String        @unique
  
  // Summary data
  matchesCount      Int           @default(0)
  dbStatus          Json?         // DB status info
  
  // Vulnerability details (normalized from matches)
  vulnerabilities   GrypeVulnerability[]
  
  createdAt         DateTime      @default(now())
  scanMetadata      ScanMetadata  @relation(fields: [scanMetadataId], references: [id], onDelete: Cascade)
  
  @@index([scanMetadataId])
  @@map("grype_results")
}

model GrypeVulnerability {
  id                String        @id @default(cuid())
  grypeResultsId    String
  
  // Core vulnerability info
  vulnerabilityId   String        // CVE ID or GHSA ID
  severity          String
  namespace         String?       // e.g., "nvd", "github"
  
  // Package info
  packageName       String
  packageVersion    String
  packageType       String        // e.g., "npm", "python", "go-module"
  packagePath       String?
  packageLanguage   String?
  
  // Fix info
  fixState          String?       // "fixed", "not-fixed", "unknown"
  fixVersions       Json?         // Array of fix versions
  
  // CVSS scores
  cvssV2Score       Float?
  cvssV2Vector      String?
  cvssV3Score       Float?
  cvssV3Vector      String?
  
  // URLs and references
  urls              Json?         // Array of reference URLs
  description       String?       @db.Text
  
  grypeResult       GrypeResults  @relation(fields: [grypeResultsId], references: [id], onDelete: Cascade)
  
  @@index([grypeResultsId])
  @@index([vulnerabilityId])
  @@index([severity])
  @@index([packageName])
  @@map("grype_vulnerabilities")
}

model TrivyResults {
  id                String        @id @default(cuid())
  scanMetadataId    String        @unique
  
  // Summary data
  schemaVersion     Int?
  artifactName      String?
  artifactType      String?
  
  // Vulnerability and misconfiguration results
  vulnerabilities   TrivyVulnerability[]
  misconfigurations TrivyMisconfiguration[]
  secrets           TrivySecret[]
  
  createdAt         DateTime      @default(now())
  scanMetadata      ScanMetadata  @relation(fields: [scanMetadataId], references: [id], onDelete: Cascade)
  
  @@index([scanMetadataId])
  @@map("trivy_results")
}

model TrivyVulnerability {
  id                String        @id @default(cuid())
  trivyResultsId    String
  
  // Target info (layer/file)
  targetName        String        // e.g., "node_modules/.../package.json"
  targetClass       String?       // e.g., "lang-pkgs", "os-pkgs"
  targetType        String?       // e.g., "npm", "debian"
  
  // Vulnerability info
  vulnerabilityId   String        // CVE ID
  pkgId             String?
  pkgName           String
  pkgPath           String?
  installedVersion  String?
  fixedVersion      String?
  status            String?       // e.g., "affected", "fixed"
  
  // Severity and scoring
  severity          String
  severitySource    String?       // e.g., "nvd", "redhat"
  primaryUrl        String?
  
  // CVSS data
  cvssScore         Float?
  cvssVector        String?
  cvssScoreV3       Float?
  cvssVectorV3      String?
  
  // Additional info
  title             String?       @db.Text
  description       String?       @db.Text
  publishedDate     DateTime?
  lastModifiedDate  DateTime?
  
  // References
  references        Json?         // Array of reference URLs
  
  trivyResult       TrivyResults  @relation(fields: [trivyResultsId], references: [id], onDelete: Cascade)
  
  @@index([trivyResultsId])
  @@index([vulnerabilityId])
  @@index([severity])
  @@index([pkgName])
  @@index([targetName])
  @@map("trivy_vulnerabilities")
}

model TrivyMisconfiguration {
  id                String        @id @default(cuid())
  trivyResultsId    String
  
  // Target info
  targetName        String
  targetClass       String?
  targetType        String?
  
  // Misconfiguration details
  checkId           String
  avdId             String?
  title             String
  description       String        @db.Text
  message           String        @db.Text
  namespace         String?
  query             String?       @db.Text
  
  // Severity and resolution
  severity          String
  resolution        String?       @db.Text
  status            String        // e.g., "PASS", "FAIL"
  
  // Location
  startLine         Int?
  endLine           Int?
  code              Json?         // Code lines array
  
  // References
  primaryUrl        String?
  references        Json?         // Array of URLs
  
  trivyResult       TrivyResults  @relation(fields: [trivyResultsId], references: [id], onDelete: Cascade)
  
  @@index([trivyResultsId])
  @@index([checkId])
  @@index([severity])
  @@index([status])
  @@map("trivy_misconfigurations")
}

model TrivySecret {
  id                String        @id @default(cuid())
  trivyResultsId    String
  
  // Target info
  targetName        String
  
  // Secret details
  ruleId            String
  category          String
  severity          String
  title             String
  
  // Location
  startLine         Int
  endLine           Int
  code              Json?         // Code lines array
  match             String?       // The actual match (redacted)
  
  // Layer info
  layer             String?
  
  trivyResult       TrivyResults  @relation(fields: [trivyResultsId], references: [id], onDelete: Cascade)
  
  @@index([trivyResultsId])
  @@index([ruleId])
  @@index([severity])
  @@map("trivy_secrets")
}

model DiveResults {
  id                String        @id @default(cuid())
  scanMetadataId    String        @unique
  
  // Efficiency metrics
  efficiencyScore   Float         // 0-100
  sizeBytes         BigInt
  wastedBytes       BigInt
  wastedPercent     Float
  
  // Layer analysis
  layers            DiveLayer[]
  
  // File tree analysis
  inefficientFiles  Json?         // Array of inefficient files
  duplicateFiles    Json?         // Array of duplicate file paths
  
  createdAt         DateTime      @default(now())
  scanMetadata      ScanMetadata  @relation(fields: [scanMetadataId], references: [id], onDelete: Cascade)
  
  @@index([scanMetadataId])
  @@index([efficiencyScore])
  @@map("dive_results")
}

model DiveLayer {
  id                String        @id @default(cuid())
  diveResultsId     String
  
  // Layer identification
  layerId           String
  layerIndex        Int
  digest            String
  
  // Size metrics
  sizeBytes         BigInt
  command           String?       @db.Text
  
  // Analysis results
  addedFiles        Int           @default(0)
  modifiedFiles     Int           @default(0)
  removedFiles      Int           @default(0)
  wastedBytes       BigInt        @default(0)
  
  // File details (optional, for detailed analysis)
  fileDetails       Json?         // Array of file changes
  
  diveResult        DiveResults   @relation(fields: [diveResultsId], references: [id], onDelete: Cascade)
  
  @@index([diveResultsId])
  @@index([layerIndex])
  @@map("dive_layers")
}

model SyftResults {
  id                String        @id @default(cuid())
  scanMetadataId    String        @unique
  
  // SBOM metadata
  schemaVersion     String?
  bomFormat         String?       // e.g., "CycloneDX", "SPDX"
  specVersion       String?
  serialNumber      String?
  
  // Summary counts
  packagesCount     Int           @default(0)
  filesAnalyzed     Int           @default(0)
  
  // Package details
  packages          SyftPackage[]
  
  // Source info
  source            Json?         // Source metadata
  distro            Json?         // OS distribution info
  
  createdAt         DateTime      @default(now())
  scanMetadata      ScanMetadata  @relation(fields: [scanMetadataId], references: [id], onDelete: Cascade)
  
  @@index([scanMetadataId])
  @@map("syft_results")
}

model SyftPackage {
  id                String        @id @default(cuid())
  syftResultsId     String
  
  // Package identification
  packageId         String        // Syft's internal ID
  name              String
  version           String
  type              String        // e.g., "npm", "python", "go-module"
  foundBy           String?       // Cataloger that found it
  purl              String?       // Package URL
  cpe               String?       // CPE string
  
  // Package metadata
  language          String?
  licenses          Json?         // Array of licenses
  size              BigInt?
  
  // Location info
  locations         Json?         // Array of file locations
  layerId           String?
  
  // Additional metadata
  metadata          Json?         // Type-specific metadata
  
  syftResult        SyftResults   @relation(fields: [syftResultsId], references: [id], onDelete: Cascade)
  
  @@index([syftResultsId])
  @@index([name])
  @@index([type])
  @@index([purl])
  @@map("syft_packages")
}

model DockleResults {
  id                String        @id @default(cuid())
  scanMetadataId    String        @unique
  
  // Summary
  summary           Json?         // Summary object with counts
  
  // Compliance details
  violations        DockleViolation[]
  
  createdAt         DateTime      @default(now())
  scanMetadata      ScanMetadata  @relation(fields: [scanMetadataId], references: [id], onDelete: Cascade)
  
  @@index([scanMetadataId])
  @@map("dockle_results")
}

model DockleViolation {
  id                String        @id @default(cuid())
  dockleResultsId   String
  
  // Violation details
  code              String        // e.g., "CIS-DI-0001"
  title             String
  level             String        // e.g., "FATAL", "WARN", "INFO", "PASS"
  alerts            Json?         // Array of alert messages
  
  dockleResult      DockleResults @relation(fields: [dockleResultsId], references: [id], onDelete: Cascade)
  
  @@index([dockleResultsId])
  @@index([code])
  @@index([level])
  @@map("dockle_violations")
}

model OsvResults {
  id                String        @id @default(cuid())
  scanMetadataId    String        @unique
  
  // OSV scanner results
  vulnerabilities   OsvVulnerability[]
  
  createdAt         DateTime      @default(now())
  scanMetadata      ScanMetadata  @relation(fields: [scanMetadataId], references: [id], onDelete: Cascade)
  
  @@index([scanMetadataId])
  @@map("osv_results")
}

model OsvVulnerability {
  id                String        @id @default(cuid())
  osvResultsId      String
  
  // Vulnerability identification
  osvId             String        // OSV ID
  aliases           Json?         // Array of aliases (CVE IDs, etc.)
  
  // Package info
  packageName       String
  packageEcosystem  String        // e.g., "npm", "PyPI"
  packageVersion    String
  packagePurl       String?
  
  // Vulnerability details
  summary           String?       @db.Text
  details           String?       @db.Text
  severity          Json?         // Array of severity assessments
  
  // Fix info
  fixed             String?       // Fixed version
  affected          Json?         // Affected version ranges
  
  // Dates
  published         DateTime?
  modified          DateTime?
  withdrawn         DateTime?
  
  // References
  references        Json?         // Array of reference URLs
  databaseSpecific  Json?         // Database-specific fields
  
  osvResult         OsvResults    @relation(fields: [osvResultsId], references: [id], onDelete: Cascade)
  
  @@index([osvResultsId])
  @@index([osvId])
  @@index([packageName])
  @@map("osv_vulnerabilities")
}

model ScanResult {
  id           String           @id @default(cuid())
  scanId       String
  scannerId    String
  rawOutput    Json?
  status       ScanResultStatus @default(SUCCESS)
  errorMessage String?
  createdAt    DateTime         @default(now())
  scan         Scan             @relation(fields: [scanId], references: [id], onDelete: Cascade)
  scanner      Scanner          @relation(fields: [scannerId], references: [id])

  @@index([scanId])
  @@index([scannerId])
  @@index([status])
  @@map("scan_results")
}

model Scanner {
  id            String       @id @default(cuid())
  name          String       @unique
  version       String
  type          ScannerType
  isActive      Boolean      @default(true)
  defaultConfig Json?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  scanResults   ScanResult[]

  @@index([name])
  @@index([type])
  @@index([isActive])
  @@map("scanners")
}

model BulkScanBatch {
  id           String         @id @default(cuid())
  totalImages  Int
  status       BatchStatus
  patterns     Json
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  completedAt  DateTime?
  errorMessage String?
  name         String?
  items        BulkScanItem[]

  @@index([status])
  @@index([createdAt])
  @@map("bulk_scan_batches")
}

model BulkScanItem {
  id      String        @id @default(cuid())
  batchId String
  scanId  String
  imageId String
  status  ItemStatus
  batch   BulkScanBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)
  image   Image         @relation(fields: [imageId], references: [id], onDelete: Cascade)
  scan    Scan          @relation(fields: [scanId], references: [id], onDelete: Cascade)

  @@index([batchId])
  @@index([status])
  @@map("bulk_scan_items")
}

model Vulnerability {
  id                   String               @id @default(cuid())
  cveId                String               @unique
  title                String?
  description          String?
  severity             Severity
  cvssScore            Float?
  source               String?
  publishedAt          DateTime?
  modifiedAt           DateTime?
  imageVulnerabilities ImageVulnerability[]

  @@index([cveId])
  @@index([severity])
  @@index([cvssScore])
  @@map("vulnerabilities")
}

model ImageVulnerability {
  id                 String              @id @default(cuid())
  imageId            String
  vulnerabilityId    String
  packageName        String
  installedVersion   String?
  fixedVersion       String?
  status             VulnerabilityStatus @default(DETECTED)
  patchStatus        PatchStatus         @default(NOT_ATTEMPTED)
  detectedAt         DateTime            @default(now())
  cveClassifications CveClassification[]
  image              Image               @relation(fields: [imageId], references: [id], onDelete: Cascade)
  vulnerability      Vulnerability       @relation(fields: [vulnerabilityId], references: [id], onDelete: Cascade)
  patchOperations    PatchOperation[]

  @@unique([imageId, vulnerabilityId, packageName])
  @@index([imageId])
  @@index([vulnerabilityId])
  @@index([status])
  @@index([packageName])
  @@index([patchStatus])
  @@map("image_vulnerabilities")
}

model CveClassification {
  id                   String             @id @default(cuid())
  imageVulnerabilityId String
  isFalsePositive      Boolean            @default(false)
  comment              String?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  createdBy            String?
  imageId              String
  image                Image              @relation(fields: [imageId], references: [id], onDelete: Cascade)
  imageVulnerability   ImageVulnerability @relation(fields: [imageVulnerabilityId], references: [id], onDelete: Cascade)

  @@index([imageVulnerabilityId])
  @@index([imageId])
  @@index([isFalsePositive])
  @@map("cve_classifications")
}


model AuditLog {
  id        String      @id @default(cuid())
  eventType EventType
  category  LogCategory
  userIp    String
  userAgent String?
  userId    String?
  resource  String?
  action    LogAction
  details   Json?
  metadata  Json?
  timestamp DateTime    @default(now())

  @@index([eventType])
  @@index([category])
  @@index([userIp])
  @@index([timestamp])
  @@index([resource])
  @@map("audit_logs")
}

model Repository {
  id                String           @id @default(cuid())
  name              String
  type              RepositoryType
  protocol          String           @default("https")
  registryUrl       String
  username          String
  encryptedPassword String
  organization      String?
  status            RepositoryStatus @default(UNTESTED)
  lastTested        DateTime?
  repositoryCount   Int?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@map("repositories")
}

// ============================================
// Scanner Finding Tables - Normalized Results
// ============================================

model ScanVulnerabilityFinding {
  id                String   @id @default(cuid())
  scanId            String
  source            String   // 'trivy', 'grype', 'osv'
  
  // Core vulnerability info
  cveId             String
  packageName       String
  installedVersion  String?
  fixedVersion      String?
  severity          Severity
  cvssScore         Float?
  
  // Source-specific metadata
  dataSource        String?  // 'nvd', 'ghsa', 'redhat', etc.
  vulnerabilityUrl  String?
  title             String?
  description       String?  @db.Text
  publishedDate     DateTime?
  lastModified      DateTime?
  
  // Location info
  filePath          String?
  layerId           String?
  packageType       String?  // 'os', 'library', 'application'
  
  // Scanner-specific raw data
  rawFinding        Json?    // Original finding from scanner
  
  createdAt         DateTime @default(now())
  scan              Scan     @relation(fields: [scanId], references: [id], onDelete: Cascade)
  
  @@index([scanId])
  @@index([cveId])
  @@index([source])
  @@index([severity])
  @@index([packageName])
  @@index([scanId, cveId, source]) // For cross-scanner analysis
  @@map("scan_vulnerability_findings")
}

model ScanPackageFinding {
  id                String   @id @default(cuid())
  scanId            String
  source            String   // 'syft', 'trivy', 'grype'
  
  // Package identification
  packageName       String
  version           String?
  type              String   // 'npm', 'python', 'go', 'os', etc.
  purl              String?  // Package URL
  
  // Package metadata
  license           String?
  vendor            String?
  publisher         String?
  ecosystem         String?
  language          String?
  
  // Location info
  filePath          String?
  layerId           String?
  installedSize     BigInt?
  
  // Additional metadata
  metadata          Json?    // Flexible field for scanner-specific data
  dependencies      Json?    // Array of dependency purls
  
  createdAt         DateTime @default(now())
  scan              Scan     @relation(fields: [scanId], references: [id], onDelete: Cascade)
  
  @@index([scanId])
  @@index([packageName])
  @@index([source])
  @@index([type])
  @@index([ecosystem])
  @@map("scan_package_findings")
}

model ScanComplianceFinding {
  id                String   @id @default(cuid())
  scanId            String
  source            String   // 'dockle', future compliance scanners
  
  // Compliance violation info
  ruleId            String
  ruleName          String
  category          String   // 'CIS', 'Security', 'BestPractice'
  severity          Severity
  
  // Details
  message           String   @db.Text
  description       String?  @db.Text
  remediation       String?  @db.Text
  
  // Context
  filePath          String?
  lineNumber        Int?
  code              String?  @db.Text
  
  // Raw data
  rawFinding        Json?
  
  createdAt         DateTime @default(now())
  scan              Scan     @relation(fields: [scanId], references: [id], onDelete: Cascade)
  
  @@index([scanId])
  @@index([ruleId])
  @@index([source])
  @@index([severity])
  @@index([category])
  @@map("scan_compliance_findings")
}

model ScanEfficiencyFinding {
  id                String   @id @default(cuid())
  scanId            String
  source            String   // 'dive', future efficiency scanners
  
  // Finding type
  findingType       String   // 'wasted_space', 'duplicate_files', 'large_layer'
  severity          String   // 'info', 'warning', 'critical'
  
  // Layer/file info
  layerId           String?
  layerIndex        Int?
  layerCommand      String?  @db.Text
  
  // Size metrics
  sizeBytes         BigInt?
  wastedBytes       BigInt?
  efficiencyScore   Float?   // 0-100
  
  // Details
  description       String   @db.Text
  filePaths         Json?    // Array of affected file paths
  
  // Raw data
  rawFinding        Json?
  
  createdAt         DateTime @default(now())
  scan              Scan     @relation(fields: [scanId], references: [id], onDelete: Cascade)
  
  @@index([scanId])
  @@index([findingType])
  @@index([source])
  @@index([layerId])
  @@map("scan_efficiency_findings")
}

// Cross-scanner correlation for consensus analysis
model ScanFindingCorrelation {
  id                String   @id @default(cuid())
  scanId            String
  
  findingType       String   // 'vulnerability', 'package', etc.
  correlationKey    String   // CVE ID, package name, etc.
  
  sources           Json     // Array of scanner names that found this
  sourceCount       Int      // Number of scanners that found this
  confidenceScore   Float    // 0-1 based on agreement
  
  // Aggregated severity (highest from all sources)
  severity          Severity?
  
  createdAt         DateTime @default(now())
  scan              Scan     @relation(fields: [scanId], references: [id], onDelete: Cascade)
  
  @@unique([scanId, findingType, correlationKey])
  @@index([scanId])
  @@index([correlationKey])
  @@index([sourceCount])
  @@map("scan_finding_correlations")
}

// ============================================
// Patch Management Tables
// ============================================

model PatchOperation {
  id                   String                @id @default(cuid())
  sourceImageId        String
  patchedImageId       String?
  scanId               String
  status               PatchOperationStatus  @default(PENDING)
  strategy             PatchStrategy
  startedAt            DateTime              @default(now())
  completedAt          DateTime?
  errorMessage         String?               @db.Text
  
  // Patch details
  vulnerabilitiesCount Int                   @default(0)
  patchedCount         Int                   @default(0)
  failedCount          Int                   @default(0)
  
  // Buildah operation details
  buildahContainerId   String?
  buildahMountPath     String?
  
  // Registry details for patched image
  patchedImageRegistry String?
  patchedImageName     String?
  patchedImageTag      String?
  patchedImageDigest   String?
  
  // Relations
  sourceImage          Image                 @relation("PatchSourceImage", fields: [sourceImageId], references: [id], onDelete: Cascade)
  patchedImage         Image?                @relation("PatchedImage", fields: [patchedImageId], references: [id], onDelete: SetNull)
  scan                 Scan                  @relation(fields: [scanId], references: [id], onDelete: Cascade)
  patchResults         PatchResult[]
  vulnerabilities      ImageVulnerability[]
  
  @@index([sourceImageId])
  @@index([patchedImageId])
  @@index([scanId])
  @@index([status])
  @@index([startedAt])
  @@map("patch_operations")
}

model PatchResult {
  id                String              @id @default(cuid())
  patchOperationId  String
  vulnerabilityId   String
  cveId             String
  packageName       String
  originalVersion   String?
  targetVersion     String?
  patchCommand      String              @db.Text
  status            PatchResultStatus   @default(PENDING)
  errorMessage      String?             @db.Text
  executedAt        DateTime?
  
  // Package manager details
  packageManager    String              // apt, yum, apk, npm, pip, etc.
  
  patchOperation    PatchOperation      @relation(fields: [patchOperationId], references: [id], onDelete: Cascade)
  
  @@index([patchOperationId])
  @@index([vulnerabilityId])
  @@index([status])
  @@map("patch_results")
}

model PatchedImage {
  id                String              @id @default(cuid())
  originalImageId   String
  patchedImageId    String              @unique
  patchOperationId  String              @unique
  
  // Comparison metrics
  originalCveCount  Int
  remainingCveCount Int
  patchedCveCount   Int
  patchEfficiency   Float               // Percentage of CVEs patched
  
  // Size comparison
  originalSize      BigInt?
  patchedSize       BigInt?
  sizeDelta         BigInt?
  
  createdAt         DateTime            @default(now())
  
  originalImage     Image               @relation("PatchedImageOriginal", fields: [originalImageId], references: [id], onDelete: Cascade)
  patchedImage      Image               @relation("PatchedImageResult", fields: [patchedImageId], references: [id], onDelete: Cascade)
  
  @@index([originalImageId])
  @@index([patchedImageId])
  @@index([createdAt])
  @@map("patched_images")
}

enum RepositoryType {
  DOCKERHUB
  GHCR
  GENERIC
}

enum RepositoryStatus {
  UNTESTED
  ACTIVE
  ERROR
}

enum ScanStatus {
  PENDING
  RUNNING
  SUCCESS
  PARTIAL
  FAILED
  CANCELLED
}

enum ScanResultStatus {
  SUCCESS
  FAILED
  PARTIAL
}

enum ScannerType {
  VULNERABILITY
  COMPLIANCE
  SBOM
  ANALYSIS
}

enum BatchStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

enum ItemStatus {
  PENDING
  RUNNING
  SUCCESS
  FAILED
  CANCELLED
}

enum Severity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
  INFO
}

enum VulnerabilityStatus {
  DETECTED
  FIXED
  IGNORED
  FALSE_POSITIVE
}

enum ImageSource {
  REGISTRY
  LOCAL_DOCKER
  FILE_UPLOAD
  REGISTRY_PRIVATE
}

enum EventType {
  SCAN_START
  SCAN_COMPLETE
  SCAN_FAILED
  IMAGE_ADDED
  IMAGE_REMOVED
  USER_LOGIN
  CONFIG_CHANGE
  SYSTEM_EVENT
}

enum LogCategory {
  SECURITY
  OPERATIONAL
  INFORMATIVE
  ERROR
}

enum LogAction {
  CREATE
  UPDATE
  DELETE
  VIEW
  SCAN
  UPLOAD
  DOWNLOAD
  LOGIN
  LOGOUT
}

enum PatchStatus {
  NOT_ATTEMPTED
  ANALYZING
  PATCHABLE
  NOT_PATCHABLE
  PATCHING
  PATCHED
  PATCH_FAILED
}

enum PatchOperationStatus {
  PENDING
  ANALYZING
  PULLING
  BUILDING
  PATCHING
  PUSHING
  VERIFYING
  COMPLETED
  FAILED
  CANCELLED
}

enum PatchResultStatus {
  PENDING
  SUCCESS
  FAILED
  SKIPPED
}

enum PatchStrategy {
  APT
  YUM
  APK
  NPM
  PIP
  MULTI
}
