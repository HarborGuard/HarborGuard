-- Add performance indexes for vulnerabilities API query optimization

-- Enable pg_trgm extension for efficient ILIKE searches (if not already enabled)
CREATE EXTENSION IF NOT EXISTS pg_trgm;

-- Composite index for CVE aggregation and grouping
-- This helps with GROUP BY cveId and ORDER BY severity, cvssScore
CREATE INDEX IF NOT EXISTS "scan_vulnerability_findings_cve_severity_cvss_idx"
ON "public"."scan_vulnerability_findings"("cveId", severity DESC, "cvssScore" DESC NULLS LAST);

-- Composite index for COUNT(DISTINCT scanId) per CVE
CREATE INDEX IF NOT EXISTS "scan_vulnerability_findings_cve_scan_idx"
ON "public"."scan_vulnerability_findings"("cveId", "scanId");

-- Covering index for search queries with severity filter
CREATE INDEX IF NOT EXISTS "scan_vulnerability_findings_severity_cover_idx"
ON "public"."scan_vulnerability_findings"(severity, "cveId", "cvssScore" DESC, "packageName");

-- GIN indexes for efficient ILIKE text search using trigram matching
CREATE INDEX IF NOT EXISTS "scan_vulnerability_findings_cveid_trgm_idx"
ON "public"."scan_vulnerability_findings" USING GIN ("cveId" gin_trgm_ops);

CREATE INDEX IF NOT EXISTS "scan_vulnerability_findings_packagename_trgm_idx"
ON "public"."scan_vulnerability_findings" USING GIN ("packageName" gin_trgm_ops);

CREATE INDEX IF NOT EXISTS "scan_vulnerability_findings_description_trgm_idx"
ON "public"."scan_vulnerability_findings" USING GIN (description gin_trgm_ops);

CREATE INDEX IF NOT EXISTS "scan_vulnerability_findings_title_trgm_idx"
ON "public"."scan_vulnerability_findings" USING GIN (title gin_trgm_ops);

-- Composite index for combined severity + search scenarios
-- This helps when filtering by severity AND searching
CREATE INDEX IF NOT EXISTS "scan_vulnerability_findings_severity_cve_idx"
ON "public"."scan_vulnerability_findings"(severity, "cveId", "cvssScore" DESC);
